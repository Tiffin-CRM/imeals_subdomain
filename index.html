<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IMeals User Registeration</title>
    <link rel="stylesheet"
        href="assets/base.css?<?php echo filemtime($_SERVER['DOCUMENT_ROOT'] . 'assets/base.css'); ?>">
    <link rel="stylesheet"
        href="assets/style.css?<?php echo filemtime($_SERVER['DOCUMENT_ROOT'] . 'assets/style.css'); ?>">
    <script src="https://unpkg.com/@dotlottie/player-component@latest/dist/dotlottie-player.mjs" type="module"></script>
    <link rel="preload" href="https://lottie.host/0bce2892-f33a-4e03-8723-084484b362c7/sDnHjQ79oG.json" as="fetch"
        type="application/json" crossorigin="anonymous">
    <link rel="preload" href="https://lottie.host/dcc2ef95-baa4-4c58-bc6c-96cd7ad39738/Q5JyZC9T9T.json" as="fetch"
        type="application/json" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/iconify-icon@2.1.0/dist/iconify-icon.min.js"></script>
</head>
<style>
    .hideit {
        display: none;
    }
</style>
<style>
    body {
        background: #faf9ff;
        padding: 10px;
        font-family: "Inter", sans-serif;
        font-optical-sizing: auto;
        color: #313131;
    }

    .heading_box h2,
    .heading_box p,
    .heading_box svg {
        margin: 2px auto;
    }

    .container {
        max-width: 800px;
        padding: 20px 0px;
        width: 100%;
        margin: 2px auto;
    }

    .heading_box {
        padding: 20px;
        text-align: center;
        border-radius: 5px;
        border: 1px solid #e5e5e5;
        background: #fff;
        margin: 0px auto;
        display: flex;
        /* Make the container a flexbox */
        flex-direction: row;
        /* Set the flex direction to column */
        justify-content: center;
    }

    h2 {
        color: #313131;
        font-size: 24px;
        font-weight: 700;
    }

    p {
        color: #313131;
        font-size: 14px;
    }

    .form_div {
        margin-top: 60px;
    }

    .input_styling {
        width: 100%;
        padding: 18px;
        font-size: 16px;
        border: 1px solid #e5e5e5;
        margin-top: 8px;
        box-sizing: border-box;
        /* Add this line */
        border-radius: 5px;
    }

    input:focus {
        outline-color: #2e069c;
        /* This will change the color of the focus outline to blue when you click on an input field */
    }

    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
        /* Optional - removes the margin for Firefox */
    }

    .input_div label {
        font-size: 16px;
        font-weight: 700;
    }

    .input_div {
        margin: 20px auto;
    }

    .button {
        border-radius: 5px;
        border: 1px solid #dfdfdf;
        background: linear-gradient(90deg, #6078FE 0%, #2e069c 100%);
        color: #f3f3f3;
        font-weight: 600;
        font-size: 16px;
        text-align: center;
    }

    .hideit {
        display: none;
    }

    .cur {
        cursor: pointer;
    }

    .response {
        text-align: center;
        font-size: 16px;
        color: #353535;
        font-weight: 500;
    }

    .lottieimg {
        display: flex;
        justify-content: center;
        align-items: center;
        /* height: 30vh; */
        margin: 20px auto;
        align-items: center;
        width: 70%;

    }

    /* Full-page overlay style */
    .loading-layer {
        display: none;
        position: fixed;
        z-index: 9999;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        justify-content: center;
        align-items: center;
    }

    /* Loader animation style */
    .loader {
        border: 8px solid #f3f3f3;
        /* Light grey */
        border-top: 8px solid #3498db;
        /* Blue */
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 2s linear infinite;
    }

    /* Loader animation */
    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    body.has-top-bar {
        padding-top: 50px;
    }
</style>
<style>
    .top-bar {
        width: 100%;
        background: linear-gradient(90deg, #6078FE 0%, #2e069c 100%);
        color: white;
        padding: 15px;
        text-align: center;
        position: fixed;
        top: 0;
        left: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        font-family: Arial, sans-serif;
        font-size: 18px;
    }


    /* Style for the rotating circle */
    .circle {
        width: 16px;
        height: 16px;
        border: 3px solid white;
        border-radius: 50%;
        border-top-color: transparent;
        animation: spin 1.2s cubic-bezier(0.68, -0.55, 0.27, 1.55) infinite;
        margin-right: 10px;
    }

    /* Keyframes for rotating animation */
    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    /* Style for the animated dots */
    .dots::after {
        content: " ";
        animation: dots 1.5s ease-in-out infinite;
    }

    /* Keyframes for dots animation */
    @keyframes dots {

        0%,
        20% {
            content: "";
        }

        40% {
            content: ".";
        }

        60% {
            content: "..";
        }

        80%,
        100% {
            content: "...";
        }
    }

    .response_top_bar {
        background: rgb(212, 0, 0);
        color: rgb(255, 255, 255);
        font-weight: bolder;
        font-size: 12px;
    }
</style>

<body>
    <main>
        <div class="top-bar" style="display: none;" on>
            <div class="circle"></div>
            <span id="message">Automatically Login in</span>
            <span class="dots"></span>
        </div>
        <div class="top-bar response_top_bar" style="display:none;" id="response_top_bar">
            <span id="message">No Customer Found With this Phone Number</span>
        </div>
        <section class="full_section">

            <div class="page_info">
                <img src="https://momscanteen.in/wp-content/uploads/2021/09/moms_canteen_logo.png" alt="" width="100px">
                <h2 id="title">Login/Signup Now</h2>
                <span>Welcome to Mom's Canteen</span>
                <span>Enter your Phone number to login/signup</span>
            </div>
        </section>
        <section class="full_section">
            <div class="form_container">
                <div id="signup_form">
                    <div class="input_field_container">
                        <label for="phone">Phone Number</label>
                        <input type="number" name="phone" id="phoneNumber" placeholder="Enter Your Phone Number here"
                            value="9253029002" onclick="truecaller_push();" required>
                        <span class="input_desc">Without Country Code</span>
                        <small id="phone_error" class="error_message"></small>
                    </div>
                    <div class="input_field_container">
                        <button type="submit" class="submit_btn r-flex ali-c jut-c gap-1" id="send_otp"
                            onclick="check_number()">Get OTP<iconify-icon icon="ooui:arrow-next-ltr"
                                height="14"></iconify-icon></button>
                    </div>
                    <div id="otp_section" class="hideit">
                        <div class="input_field_container">
                            <label for="otp">OTP</label>
                            <input type="number" name="otp" id="otpInput" placeholder="Enter 4 Digit OTP here"
                                min="1000" max="9999" maxlength="4" class="input_styling" required>
                            <span class="input_desc" id="resultMessage" class="hideit response">OTP Sent</span>
                            <small id="otp_error" class="error_message"></small>
                        </div>
                        <div class="input_field_container">
                            <button class="submit_btn r-flex ali-c jut-c gap-1" onclick="getOTP()">Get
                                OTP<iconify-icon icon="ooui:arrow-next-ltr" height="14"></iconify-icon></button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <section class="full_section">
            <div class="extra_btn_container">
                <div class="c-flex ali-c">
                    <hr style="width: 100%;">
                    <span class="or_text">OR</span>
                </div>
                <button class="secondary_btn">Check Our Plans</button>
            </div>
            <div class="need_help_container">
                <span>Need Help?</span>
                <a href="#">Contact Us</a>
            </div>
        </section>
    </main>
    <div style="margin: 40px auto;text-align: center;">
        <span id="request_id" onclick="try_truecaller_login();get_truecaller_response();">Request Id</span> <br>
        <span id="userInfo">Response Here</span>
        <p id="show_response" class="response">

        </p>
    </div>
    <div id="overlay" class="overlay">
        <div class="overlay-content page_info">
            <dotlottie-player id="lottiePlayer"
                src="https://lottie.host/0bce2892-f33a-4e03-8723-084484b362c7/sDnHjQ79oG.json" background="transparent"
                speed="1" style="width: 300px; height: 200px;" speed="2" loop autoplay></dotlottie-player>
            <h3 id="overlay_title">Signing Up...</h3>
            <br>
            <span id="overlay_desc">Your Details are being checked.. </span>
            <button id="overlay_btn" class="submit_btn" style="display: none;">Add Yor Meal Plan Now</button>
            <!-- <button onclick="changeLottie()">Change Lottie</button> -->
            <span id="closeOverlay">Close</span>
        </div>
    </div>
    <div id="loadingLayer" class="loading-layer">
        <div class="loader"></div>
    </div>
</body>

<script>
    const overlay_desc = document.getElementById('overlay_desc');
    const overlay_title = document.getElementById('overlay_title');
    const overlay_btn = document.getElementById('overlay_btn');


    function show_bottom_popup(title, desc) {
        document.getElementById("overlay").style.display = "flex"; // Show the overlay
        document.body.classList.add('noscroll'); // Prevent background scrolling
        overlay_title.innerText = title;
        overlay_desc.innerText = desc; // Show loading message
    }

    function overlay_lottie(url) {
        const player = document.getElementById('lottiePlayer');
        const defaultUrl = "https://lottie.host/dcc2ef95-baa4-4c58-bc6c-96cd7ad39738/Q5JyZC9T9T.json";
        player.load(url || defaultUrl);
    }

    function trucaller_got_number() {
        show_bottom_popup('Getting Your Account Info..', 'Checking if you have an account with us...');
        check_if_account();
    }

    function account_found() {
        overlay_lottie('https://lottie.host/dcc2ef95-baa4-4c58-bc6c-96cd7ad39738/Q5JyZC9T9T.json')
        show_bottom_popup('Account Found..Loging In', 'We are redirecting you to Login Page.');
        alert("Account Found");
    }
    function account_not_found() {
        show_bottom_popup('Account Not Found..', 'If You want to create an account with us, click on Create Account.');
        overlay_btn.innerHTML = 'Create Account';
        overlay_btn.onclick = function () {
            window.location.href = "/signup.php";
        };
        overlay_btn.style.display = 'block';
    }
    function check_if_account() {
        var phoneNumber = localStorage.getItem("phone");
        var token = localStorage.getItem("token");

        // Ensure phoneNumber and token are available
        if (!phoneNumber || !token) {
            alert("Phone number or token is missing.");
            return;
        }

        fetch("/php/check_account.php", {
            method: "POST",
            body: JSON.stringify({ phone: phoneNumber, token: token }),
            headers: {
                "Content-Type": "application/json",
            },
        })
            .then((response) => {
                if (!response.ok) {
                    throw new Error("Network response was not ok " + response.statusText);
                }
                return response.json();
            })
            .then((data) => {
                console.log(data); // Log the response from the server
                alert(data.message); // Show message received from server

                if (data.usertype === "existing") {
                    account_found();
                } else if (data.usertype === "new") {
                    account_not_found();
                } else {
                    console.error("Unexpected usertype:", data.usertype);
                }
            })
            .catch((error) => {
                console.error("Error:", error);
                alert("There was a problem with the request.");
            });
    }

    function sendOTP() {
        var phoneNumber = document.getElementById("phoneNumber").value;
        document.getElementById("phoneNumber").disabled = true;
        document.getElementById("send_otp").classList.add("hideit");
        document.getElementById("otp_section").classList.remove("hideit");
        fetch("/php/send_otp.php", {
            method: "POST",
            body: JSON.stringify({ phoneNumber: phoneNumber }),
            headers: {
                "Content-Type": "application/json",
            },
        })
            .then((response) => response.json())
            .then((data) => {
                console.log(data); // Log the response from the server
            })
            .catch((error) => console.error("Error:", error));
    }

    function getOTP() {
        var enteredOTP = document.getElementById("otpInput").value;

        var otpPattern = /^\d{4}$/;
        if (!otpPattern.test(enteredOTP)) {
            alert("Please enter a valid otp"); // Display error message
        } else {
            fetch("/php/verify_otp.php", {
                method: "POST",
                body: JSON.stringify({ otp: enteredOTP }),
                headers: {
                    "Content-Type": "application/json",
                },
            })
                .then((response) => response.json())
                .then((data) => {
                    console.log("Response from server:", data); // Log response data for debugging

                    if (
                        data.hasOwnProperty("message") &&
                        data.message === "OTP Verified successfully!"
                    ) {
                        console.log(
                            "OTP verification successful. Redirecting to logged-in page..."
                        );
                        window.location.href = "user.php";
                    } else {
                        // If OTP verification fails, display an error message to the user
                        document.getElementById("resultMessage").innerText = data.message;
                        document.getElementById("resultMessage").classList.remove("hideit");
                    }
                })
                .catch((error) => console.error("Error:", error));
        }
    }

    function check_number() {
        var phoneNumber = document.getElementById("phoneNumber").value;
        // Regular expression to validate phone number format (E.164 format)
        var phoneNumberPattern = /^\d{10}$/;

        if (phoneNumberPattern.test(phoneNumber)) {
            sendOTP(); // If phone number format is correct, proceed to send OTP
        } else {
            alert("Please enter a valid phone number"); // Display error message
        }
    }
</script>
<script>
    let truecaller_request_id = null; // Initialize as null
    let isSuccess = false; // Global success flag
    let retryCount = 0; // Retry attempt counter
    let pushed_truecaller = false;
    function try_truecaller_login() {
        const partnerName = "Imeals";
        const privacyUrl = "https://imeals.in/privacy-policy";
        const termsUrl = "https://imeals.in/terms";
        const loginPrefix = "proceed";
        const loginSuffix = "verifymobile";
        const ctaPrefix = "proceedwith";
        const ctaColor = encodeURIComponent("default");
        const ctaTextColor = encodeURIComponent("default");
        const btnShape = "round";
        const skipOption = "manualdetails";
        const ttl = 60000;
        const randomid = Math.floor(Math.random() * 1000000);
        truecaller_request_id = randomid + Date.now(); // Set global request ID
        truecaller_request_id = 1727869390549; // Set global request ID
        document.getElementById("request_id").innerHTML = truecaller_request_id;
        // Properly formatted URL
        //  window.location = `truecallersdk://truesdk/web_verify?type=btmsheet&requestNonce=${truecaller_request_id}&partnerKey=Wxruhf8a1644c5276496993024a726dc506f1&partnerName=${partnerName}&lang=en&privacyUrl=${privacyUrl}&termsUrl=${termsUrl}&loginPrefix=${loginPrefix}&loginSuffix=${loginSuffix}&ctaPrefix=${ctaPrefix}&ctaColor=${ctaColor}&ctaTextColor=${ctaTextColor}&btnShape=${btnShape}&skipOption=${skipOption}&ttl=${ttl}`;
        setTimeout(function () {
            if (document.hasFocus()) {
                // Truecaller app not present on the device and you redirect the user
                // to your alternate verification page
            } else {
                page_loading(true);
                // Add an event listener to the window for the 'focus' event
                window.addEventListener("focus", function () {
                    get_truecaller_response();
                });
            }
        }, 600);
    }

    // Add event listener to the button
    function get_truecaller_response() {
        if (truecaller_request_id) {
            page_loading(true);
            // Make a POST request to the PHP endpoint to fetch user info
            fetch("https://imeals.in/truecaller/get_response.php", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    truecaller_request_id,
                }),
            })
                .then((response) => response.json())
                .then((data) => {
                    if (data.status === "ok") {
                        // Display the user info in HTML
                        isSuccess = true;
                        const userInfo = data.data;

                        // Prepare HTML output
                        let htmlContent = `<p>${JSON.stringify(userInfo, null, 2)}</p>
  `;
                        // Inject the HTML content into the userInfo div
                        document.getElementById(
                            "userInfo"
                        ).innerHTML = `<pre>${htmlContent}</pre>`;
                        // Store data in localStorage
                        localStorage.setItem("userInfoData", JSON.stringify(userInfo));
                        localStorage.setItem("token", userInfo.token);
                        localStorage.setItem("phone", userInfo.phoneNumber);
                        localStorage.setItem("name", userInfo.fullName);
                        localStorage.setItem("email", userInfo.email);
                        document.getElementById("phoneNumber").value = parseInt(userInfo.phoneNumber, 10);
                        page_loading(false);
                        trucaller_got_number();
                    } else {
                        // Display error message
                        retryRequest(retryCount + 1); // Call retryRequest
                        document.getElementById(
                            "userInfo"
                        ).innerHTML = `<p style="color: red;">Error: ${data.message}</p>`;
                    }
                })

                .catch((error) => {
                    console.error("Fetch error:", error);
                    document.getElementById(
                        "userInfo"
                    ).innerHTML = `<p style="color: red;">Error: ${error}</p>`;
                });
            page_loading(false);
        } else {
            // Display an error if truecaller_request_id is empty
            document.getElementById(
                "userInfo"
            ).innerHTML = `<p style="color: red;">Please enter a Request ID.</p>`;
            page_loading(false);
        }
    }

    function retryRequest(attempt) {
        const maxAttempts = 30;
        const interval = attempt <= 20 ? 3000 : attempt <= 25 ? 6000 : 60000;

        if (attempt <= maxAttempts && !isSuccess) {
            setTimeout(() => {
                retryCount = attempt; // Update retry count
                get_truecaller_response(); // Retry fetching response
            }, interval);
        }
    }
    function page_loading(isLoading) {
        var loadingLayer = document.getElementById("loadingLayer");
        if (isLoading) {
            loadingLayer.style.display = "flex";
        } else {
            loadingLayer.style.display = "none";
        }
    }
    function truecaller_push() {
        if (!pushed_truecaller) {
            // Check if the user is on a mobile device and using Android
            var isAndroid = /Android/i.test(navigator.userAgent);

            if (isAndroid) {
                try_truecaller_login();
                pushed_truecaller = true;
            }
        }
    }
</script>
<script>
    (function () {
        let cookieEnabled = false;
        let localStorageEnabled = false;
        let sessionSupported = false;

        // Check if cookies are supported
        try {
            document.cookie = "testcookie=1; max-age=60";
            cookieEnabled = document.cookie.indexOf("testcookie=1") !== -1;
        } catch (e) {
            cookieEnabled = false;
        }

        // Check if localStorage is supported
        try {
            localStorage.setItem("testLS", "1");
            localStorageEnabled = localStorage.getItem("testLS") === "1";
        } catch (e) {
            localStorageEnabled = false;
        }

        // Check if sessionStorage is supported
        try {
            sessionStorage.setItem("testSession", "1");
            sessionSupported = sessionStorage.getItem("testSession") === "1";
        } catch (e) {
            sessionSupported = false;
        }

        // Run the check only if not already tested
        try {
            if (!localStorage.getItem("browserChecked")) {
                if (!cookieEnabled || !localStorageEnabled || !sessionSupported) {
                    alert(
                        "Your browser doesn't fully support cookies, local storage, or session persistence. Some features may not work."
                    );
                }
                localStorage.setItem("browserChecked", "true");
            }
        } catch (e) {
            // If localStorage access fails, still alert the user
            if (!cookieEnabled || !localStorageEnabled || !sessionSupported) {
                alert(
                    "Your browser doesn't fully support cookies, local storage, or session persistence. Some features may not work."
                );
            }
        }
    })();

    // Get the URL parameters
    const urlParams = new URLSearchParams(window.location.search);

    // Check if the parameter 'response' equals 'Phone Not Found'
    if (urlParams.get('show_response') === 'Phone Not Found') {
        // Apply display: flex to the element with id #response_top_bar
        document.getElementById('response_top_bar').style.display = 'flex';
        document.body.classList.add("has-top-bar");
    }

</script>
<script>
    document.getElementById("title").addEventListener("click", function (event) {
        document.body.classList.add('noscroll'); // Prevent background scrolling
        document.getElementById("overlay").style.display = "flex"; // Show the overlay
    });
    document.getElementById("closeOverlay").addEventListener("click", function () {
        document.getElementById("overlay").style.display = "none"; // Hide the overlay
        document.body.classList.remove('noscroll'); // Prevent background scrolling
    });
</script>

</html>